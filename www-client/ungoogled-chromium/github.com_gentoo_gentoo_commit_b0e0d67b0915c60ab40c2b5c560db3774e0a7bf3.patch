From b0e0d67b0915c60ab40c2b5c560db3774e0a7bf3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Niccol=C3=B2=20Belli?= <niccolo.belli@linuxsystems.it>
Date: Tue, 5 Sep 2023 12:45:25 +0200
Subject: [PATCH] www-client/chromium: fix ppc64 patchset for 115 and 116
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Closes: https://bugs.gentoo.org/913348
Signed-off-by: Niccol√≤ Belli <niccolo.belli@linuxsystems.it>
---
 www-client/chromium/Manifest                       | 2 ++
 www-client/chromium/chromium-115.0.5790.170.ebuild | 6 ++++--
 www-client/chromium/chromium-116.0.5845.140.ebuild | 6 +++++-
 www-client/chromium/chromium-116.0.5845.96.ebuild  | 8 +++++---
 4 files changed, 16 insertions(+), 6 deletions(-)

diff --git a/www-client/chromium/Manifest b/www-client/chromium/Manifest
index f4a392a41fa02..21358f5c8223a 100644
--- a/www-client/chromium/Manifest
+++ b/www-client/chromium/Manifest
@@ -1,5 +1,7 @@
+DIST chromium-115-0001-Add-PPC64-support-for-boringssl.patch.gz 45436 BLAKE2B 3568fcf2f8300b807221776a7a1bc0f56c6fe984ec9fffc5baec0d2d4bc23dd6c149316a7b8db19499fa26e6c8b8056c488296df1917de0d70f8bbd01084a625 SHA512 0dd0f195ada47f6fed90b7643ac259a7a44e19fdb91c2558173d44358eb800beadc917e81ae2368487ac4295b9cd891c6d1371a636ec0b80e6597bcfae9563ef
 DIST chromium-115-patchset-2.tar.xz 5648 BLAKE2B 6e30d36b20dea958474134f226edb477cb9fb50cb10e3732a9bd500aef1dd5a1a6c9f2cc5d0063f5e51c4120c7fd7e4a53af4a3a9ae63ba30df58000edf45539 SHA512 9cb29d2db5cadfd9f0d5b46129b25e3c6a3429e7bb2bd4c51f50b76f0c6bd87e396711e6cc2915d08653ad524c5d9292f6e37fab30110cec7641163accc02d5e
 DIST chromium-115.0.5790.170.tar.xz 1595419840 BLAKE2B ae08f2b86d69d5bd136e7451de94c673277a381edebd2ef92901608febeac3bbbe22529ebe4d477e2bfd260ed3663d97753bcf636c3026364b278db9130894e5 SHA512 0b05c66741b84d016326735614da2a29175cb1522140a56a1b5927522c626c4c49f0c4e55c6149f4e3a38be8897db560c4d29fcf1d55a02ec7798acb6188a000
+DIST chromium-116-0001-Add-PPC64-support-for-boringssl.patch.gz 45103 BLAKE2B a0b7591b620680d8474a58c457034297b4077708f6cfa1ad2aeb69a7ab7f30d2ce60c2107b95e73226c07ca96155240acfb5374fe32a8acf234fe25c20034f02 SHA512 3d1809ead094bacb03e409affcea478a93c1ca1f4596ad567906504cbfceb081a84b0d206546dda467e3e0814c68f8a200e2037433ecdb11c7c43854bb12825b
 DIST chromium-116-patchset-2.tar.xz 5944 BLAKE2B bc67611ecfa93c75e1df8e05f1cabf432bfb807b7fefeb277ff4465f233a159128fecc5b0dd6e3f4954221ac675ff3e25d225352260a695d63f26b1ca6376003 SHA512 705950b3a679714adc14ae81ec51d637ba3bcbeff6dad30d9bbacec36ec6e1776534b8d1ad85fc7e838adeb588566e195a271a9ec220015d343a3038af705456
 DIST chromium-116.0.5845.140.tar.xz 1599642528 BLAKE2B f25afb7b7aaf6ba5c7969b907fcb0a662cdc7a07aa94d3c38f5ab508c62554f405ac418794b38f9b3b12dec73182c18eafb6d87dee75b248bf1fbe05d970dec4 SHA512 309611f56b64b8b40c27d339fc87de35429905791e24e493f2d2792b56a998d81c66e3cae1c9de728c7131c60bedee76b5b42a7a8694d3fb26c48c986489d433
 DIST chromium-116.0.5845.96.tar.xz 1599788748 BLAKE2B 5489e670e82af801b81af1a74bc86fc6862b9771b424ad0d051861b37ce49625b53555b3f12fff92ff1318460760a13b9b1629cfe0acce929f1db3532e5f7207 SHA512 a47182e79784ac77bbc9902f01edb10d90c12c6b7809016fbe056a570d254d7add2d4a6bab4dde1572b7784834b7dd52d3af4c00c8502af41316710633fa4987
diff --git a/www-client/chromium/chromium-115.0.5790.170.ebuild b/www-client/chromium/chromium-115.0.5790.170.ebuild
index 21debf4a6338f..5f12d59f16a72 100644
--- a/www-client/chromium/chromium-115.0.5790.170.ebuild
+++ b/www-client/chromium/chromium-115.0.5790.170.ebuild
@@ -27,12 +27,13 @@ SRC_URI="https://commondatastorage.googleapis.com/chromium-browser-official/${P}
 	ppc64? (
 		https://quickbuild.io/~raptor-engineering-public/+archive/ubuntu/chromium/+files/chromium_${PATCHSET_PPC64}.debian.tar.xz
 		https://dev.gentoo.org/~sultan/distfiles/www-client/chromium/chromium-ppc64le-gentoo-patches-1.tar.xz
+		https://raw.githubusercontent.com/darkbasic/gentoo-files/master/chromium-115-0001-Add-PPC64-support-for-boringssl.patch.gz
 	)
 	pgo? ( https://github.com/elkablo/chromium-profiler/releases/download/v0.2/chromium-profiler-0.2.tar )"
 
 LICENSE="BSD"
 SLOT="0/stable"
-KEYWORDS="amd64 ~arm64"
+KEYWORDS="amd64 ~arm64 ~ppc64"
 IUSE="+X component-build cups cpu_flags_arm_neon debug gtk4 +hangouts headless kerberos libcxx lto +official pax-kernel pgo pic +proprietary-codecs pulseaudio qt5 qt6 screencast selinux +suid +system-av1 +system-ffmpeg +system-harfbuzz +system-icu +system-png vaapi wayland widevine"
 REQUIRED_USE="
 	component-build? ( !suid !libcxx )
@@ -347,11 +348,12 @@ src_prepare() {
 	if use ppc64 ; then
 		local p
 		for p in $(grep -v "^#" "${WORKDIR}"/debian/patches/series | grep "^ppc64le" || die); do
-			if [[ ! $p =~ "fix-breakpad-compile.patch" ]]; then
+			if [[ ! ($p =~ "fix-breakpad-compile.patch" || $p =~ "Add-PPC64-support-for-boringssl.patch") ]]; then
 				eapply "${WORKDIR}/debian/patches/${p}"
 			fi
 		done
 		PATCHES+=( "${WORKDIR}/ppc64le" )
+		PATCHES+=( "${WORKDIR}/chromium-115-0001-Add-PPC64-support-for-boringssl.patch" )
 	fi
 
 	default
diff --git a/www-client/chromium/chromium-116.0.5845.140.ebuild b/www-client/chromium/chromium-116.0.5845.140.ebuild
index 08fd6781b2144..fb3e276e120bb 100644
--- a/www-client/chromium/chromium-116.0.5845.140.ebuild
+++ b/www-client/chromium/chromium-116.0.5845.140.ebuild
@@ -21,11 +21,13 @@ HOMEPAGE="https://www.chromium.org/"
 PATCHSET="2"
 PATCHSET_NAME="chromium-$(ver_cut 1)-patchset-${PATCHSET}"
 PATCHSET_PPC64="116.0.5845.110-2raptor0~deb11u1"
+# ^ = https://quickbuild.io/~raptor-engineering-public/+archive/ubuntu/chromium
 SRC_URI="https://commondatastorage.googleapis.com/chromium-browser-official/${P}.tar.xz
 	https://github.com/stha09/chromium-patches/releases/download/${PATCHSET_NAME}/${PATCHSET_NAME}.tar.xz
 	ppc64? (
 		https://quickbuild.io/~raptor-engineering-public/+archive/ubuntu/chromium/+files/chromium_${PATCHSET_PPC64}.debian.tar.xz
 		https://dev.gentoo.org/~sultan/distfiles/www-client/chromium/chromium-ppc64le-gentoo-patches-1.tar.xz
+		https://raw.githubusercontent.com/darkbasic/gentoo-files/master/chromium-116-0001-Add-PPC64-support-for-boringssl.patch.gz
 	)
 	pgo? ( https://github.com/elkablo/chromium-profiler/releases/download/v0.2/chromium-profiler-0.2.tar )"
 
@@ -344,11 +346,13 @@ src_prepare() {
 	if use ppc64 ; then
 		local p
 		for p in $(grep -v "^#" "${WORKDIR}"/debian/patches/series | grep "^ppc64le" || die); do
-			if [[ ! $p =~ "fix-breakpad-compile.patch" ]]; then
+			# Revert to Raptor's bundled 0001-Add-PPC64-support-for-boringssl.patch starting from 117
+			if [[ ! ($p =~ "fix-breakpad-compile.patch" || $p =~ "Add-PPC64-support-for-boringssl.patch") ]]; then
 				eapply "${WORKDIR}/debian/patches/${p}"
 			fi
 		done
 		PATCHES+=( "${WORKDIR}/ppc64le" )
+		PATCHES+=( "${WORKDIR}/chromium-116-0001-Add-PPC64-support-for-boringssl.patch" )
 	fi
 
 	default
diff --git a/www-client/chromium/chromium-116.0.5845.96.ebuild b/www-client/chromium/chromium-116.0.5845.96.ebuild
index 8ffaed6a84e14..15b5a95544352 100644
--- a/www-client/chromium/chromium-116.0.5845.96.ebuild
+++ b/www-client/chromium/chromium-116.0.5845.96.ebuild
@@ -20,18 +20,19 @@ DESCRIPTION="Open-source version of Google Chrome web browser"
 HOMEPAGE="https://www.chromium.org/"
 PATCHSET="2"
 PATCHSET_NAME="chromium-$(ver_cut 1)-patchset-${PATCHSET}"
-PATCHSET_PPC64="115.0.5790.102-1raptor0~deb11u2"
+PATCHSET_PPC64="116.0.5845.110-2raptor0~deb11u1"
 SRC_URI="https://commondatastorage.googleapis.com/chromium-browser-official/${P}.tar.xz
 	https://github.com/stha09/chromium-patches/releases/download/${PATCHSET_NAME}/${PATCHSET_NAME}.tar.xz
 	ppc64? (
 		https://quickbuild.io/~raptor-engineering-public/+archive/ubuntu/chromium/+files/chromium_${PATCHSET_PPC64}.debian.tar.xz
 		https://dev.gentoo.org/~sultan/distfiles/www-client/chromium/chromium-ppc64le-gentoo-patches-1.tar.xz
+		https://raw.githubusercontent.com/darkbasic/gentoo-files/master/chromium-116-0001-Add-PPC64-support-for-boringssl.patch.gz
 	)
 	pgo? ( https://github.com/elkablo/chromium-profiler/releases/download/v0.2/chromium-profiler-0.2.tar )"
 
 LICENSE="BSD"
 SLOT="0/stable"
-KEYWORDS="amd64 ~arm64"
+KEYWORDS="amd64 ~arm64 ~ppc64"
 IUSE="+X component-build cups cpu_flags_arm_neon debug gtk4 +hangouts headless kerberos libcxx lto +official pax-kernel pgo pic +proprietary-codecs pulseaudio qt5 qt6 screencast selinux +suid +system-av1 +system-ffmpeg +system-harfbuzz +system-icu +system-png vaapi wayland widevine"
 REQUIRED_USE="
 	component-build? ( !suid !libcxx )
@@ -344,11 +345,12 @@ src_prepare() {
 	if use ppc64 ; then
 		local p
 		for p in $(grep -v "^#" "${WORKDIR}"/debian/patches/series | grep "^ppc64le" || die); do
-			if [[ ! $p =~ "fix-breakpad-compile.patch" ]]; then
+			if [[ ! ($p =~ "fix-breakpad-compile.patch" || $p =~ "Add-PPC64-support-for-boringssl.patch") ]]; then
 				eapply "${WORKDIR}/debian/patches/${p}"
 			fi
 		done
 		PATCHES+=( "${WORKDIR}/ppc64le" )
+		PATCHES+=( "${WORKDIR}/chromium-116-0001-Add-PPC64-support-for-boringssl.patch" )
 	fi
 
 	default
